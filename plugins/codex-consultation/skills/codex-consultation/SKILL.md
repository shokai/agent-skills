---
name: codex-consultation
description: >-
  Codex CLIと相談するスキル。
  ユーザーが「codexと相談して」「codexに聞いて」「codexにレビューしてもらって」と言った時に使用する。
  現在の会話コンテキストに基づいてCodex CLIにプロンプトを送り、結果を要約して報告する。
---

# Codex CLI 相談手順書

Codex CLI（OpenAI）にセカンドオピニオンを求め、その結果を要約してユーザーに報告する。
ユーザーはcodexの生出力を直接見る必要はない。Claudeがcodexの回答を咀嚼し、自分の見解と照らし合わせて報告する。

## 1. codexインストール確認

Bashツールで以下を実行する:

```
command -v codex
```

codexが見つからない場合は、ユーザーに「Codex CLIがインストールされていません」と報告して終了する。
それ以上の作業は行わない。

## 2. 相談の深さの確認

ユーザーが相談の深さを明示していない場合（「全力で」「深く」「軽く」「普通に」等の指定がない場合）、
AskUserQuestionツールで以下の3択を提示する:

| 選択肢                 | 往復回数                                          | Claudeの仮見解              | 漏れ抜けの追求度             |
| ---------------------- | ------------------------------------------------- | --------------------------- | ---------------------------- |
| **全力で深く相談する** | 2往復を原則実施（明らかに不要な場合のみスキップ） | 必ず含め、Codexに反論を促す | 積極的に反論・補完・追加追求 |
| **よく相談する**       | 必要に応じて2往復                                 | Claudeが判断                | 漏れ抜けを確認して報告       |
| **普通に相談する**     | 1往復のみ                                         | Claudeが判断                | Codexの指摘を整理して報告    |

ユーザーが明示的に深さを指定している場合はこの確認を省略し、指定に従う。

## 3. プロンプトの設計

codexに渡すプロンプトをClaude自身が設計する。以下の指針に従う:

### プロンプト設計の指針

- 会話のコンテキストから「今何について相談すべきか」を判断する
- ユーザーが明示的にテーマを指定している場合はそれに従う
- 指定がない場合は、直前の議論や作業内容から適切なテーマを選ぶ

### コンテキスト別のプロンプト例

#### 未commitの変更をレビューしたいとき

「このリポジトリの未commitの変更をレビューしてください。コードの品質、設計の妥当性、潜在的なバグ、改善点を指摘してください。」

#### 設計について相談したいとき

「以下の設計について意見をください。[設計の要約]。代替案やトレードオフがあれば提案してください。」

#### 実装方針を相談したいとき

「[タスクの要約]を実装したい。このリポジトリのコードベースを踏まえて、最適な実装方針を提案してください。」

### プロンプトの構成

1. プロジェクトの背景（簡潔に）
2. 相談したい具体的な内容
3. Claudeの現時点での仮見解（状況に応じて含める。「全力」モードでは必ず含める）
4. 指定観点以外も幅広く探索するよう依頼（常に含める）

#### Claudeの仮見解を含める場合のテンプレート

```
なお私（Claude）は現時点で以下のように考えている:
- [仮見解]

この見解の漏れ・誤りも含めて、幅広くレビューしてほしい。
指定した観点以外にも気になる点があれば積極的に報告してほしい。
```

#### 幅広い探索の依頼（常にプロンプトに含める）

指定された観点はあくまで出発点であり、制約ではない。
リポジトリを自分で探索して気になる点があれば積極的に報告してほしい、という旨を必ずプロンプトに含める。

## 4. codexの実行

Bashツールで以下の形式で実行する:

```
codex exec --ephemeral -s workspace-write -c sandbox_workspace_write.network_access=true "ここにプロンプトを入れる"
```

### 重要なオプション

- `--ephemeral` は必須。セッションを保存しない
- `-s workspace-write -c sandbox_workspace_write.network_access=true` は必須。デフォルトではサンドボックスがネットワークアクセスをブロックするため、`gh`や`curl`などの外部通信コマンドが失敗する
- ワーキングディレクトリはカレントディレクトリがそのまま使われる
- プロンプトはCLI引数として渡す（標準入力ではない）

### タイムアウト

codexの実行には時間がかかる場合がある。Bashツールのtimeoutを900000（15分）に設定する。

### 追加往復の判断

「全力」モードでは、1往復目の結果を受け取った後、2往復目を原則実施する。明らかに追加の深掘りが不要な場合（1往復目で十分網羅的な回答が得られた場合）のみスキップする。

「よく」モードでは、1往復目の結果を受け取った後、以下のいずれかに該当する場合は2往復目を実施する:

- さらに深掘りすべき重要なポイントがCodexの指摘に含まれている
- Codexの指摘にClaudeが反論・補完したいことがある
- 十分に探索されていない領域があるとClaudeが判断できる

2往復目を判断する前に、1往復目の出力にコマンド失敗の兆候がないか確認する。失敗を検知した場合は、まずClaudeが正しい情報を取得・補正してから2往復目の要否を判断する（詳細はセクション5「codexのコマンド失敗を検知した場合」を参照）。

2往復目のプロンプト構成:

**注意: `codex exec`は単発実行のため、2往復目のCodexは1往復目の記憶を持っていない。最初から文脈を全て含める必要がある。**

1. 元の相談内容の再提示（背景/目的/制約/評価観点を落とさず構造化して含める）
2. 1往復目のCodexの回答サマリー
3. Claudeの反論・補完・追加質問
4. さらに掘り下げてほしい観点

往復は原則2回まで。3回以上はユーザーに確認してから実施する。

## 5. 結果の要約と報告

codexの出力を読み取り、以下の構成でユーザーに報告する:

### 報告の構成

#### codexへの相談内容

codexに送ったプロンプトの概要を1-2文で説明する。

#### codexの回答サマリー

codexの主な指摘・提案を箇条書きで要約する。

#### Claudeの見解

- codexの指摘のうち、Claudeも同意するもの
- codexの指摘のうち、Claudeが異なる意見を持つもの（理由付き）
- codexが見落としているとClaudeが考えるポイント
- 2往復目を実施した場合は、その理由と2往復目で何が明らかになったか

**見解の姿勢:**

- codexの指摘を安易に受け入れない。Claudeとして検証を試みてから報告する
- codexが探索しなかった可能性がある領域を意識的に探す
- codexとClaudeの見解が食い違う場合は、その食い違いを価値ある情報として積極的に伝える

#### 次のアクション提案

ユーザーと相談すべき事項や、推奨する次のステップを示す。

### 報告のスタイル

- 簡潔にまとめる。冗長な引用は避ける
- codexとClaudeの見解が異なる場合は、両方の理由を説明してユーザーが判断できるようにする
- ユーザーが次に何をすべきか明確にする

### codexの出力が大きすぎる場合

codexの出力量が多く、要約や処理が困難だと判断した場合は、以下の手順に従う:

1. まずユーザーに「codexの出力が非常に長かった」旨を報告する
2. 出力の冒頭部分から読み取れる概要だけを伝える
3. ユーザーと相談して対処方法を決める（例: 観点を絞って再実行、プロンプトに出力量の制約を追加、など）

事前にプロンプトで出力量を制限しない。制限すると重要な情報が欠落するリスクがある。

### codexのコマンド失敗を検知した場合

codexの出力を読む際、コマンド実行の失敗の兆候がないか注意深く確認する。
兆候の例: エラーメッセージ、「取得できなかった」「失敗した」「permission denied」「not found」など。

失敗を検知した場合は、以下の手順に従う:

1. まず、Claudeが正しい情報を自分で取得する。codexが失敗したコマンド（例: `gh pr view`）をBashツールで実行し、結果を確認する
2. 次に、取得した情報でcodexの分析を補正する。情報不足で的外れになった指摘を特定し、正しい文脈で再評価する
3. 最後に、報告の「Claudeの見解」で情報不足を明示する。欠落情報と、その影響を受けた指摘を具体的に説明する

## 6. スキルの自己改善

codexが何らかの失敗をしたパターンを認識したら、次回以降の改善策をユーザーに進言する。
