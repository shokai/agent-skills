---
name: codex-consultation
description: >-
  Codex CLIと相談するスキル。
  ユーザーが「codexと相談して」「codexに聞いて」「codexにレビューしてもらって」と言った時に使用する。
  現在の会話コンテキストに基づいてCodex CLIにプロンプトを送り、結果を要約して報告する。
---

# Codex CLI 相談手順書

Codex CLI（OpenAI）にセカンドオピニオンを求め、その結果を要約してユーザーに報告する。
ユーザーはcodexの生出力を直接見る必要はない。Claudeがcodexの回答を咀嚼し、自分の見解と照らし合わせて報告する。

## 1. codexインストール確認

Bashツールで以下を実行する:

```
command -v codex
```

codexが見つからない場合は、ユーザーに「Codex CLIがインストールされていません」と報告して終了する。
それ以上の作業は行わない。

## 2. プロンプトの設計

codexに渡すプロンプトをClaude自身が設計する。以下の指針に従う:

### プロンプト設計の指針

- 会話のコンテキストから「今何について相談すべきか」を判断する
- ユーザーが明示的にテーマを指定している場合はそれに従う
- 指定がない場合は、直前の議論や作業内容から適切なテーマを選ぶ

### コンテキスト別のプロンプト例

#### 未commitの変更をレビューしたいとき

「このリポジトリの未commitの変更をレビューしてください。コードの品質、設計の妥当性、潜在的なバグ、改善点を指摘してください。」

#### 設計について相談したいとき

「以下の設計について意見をください。[設計の要約]。代替案やトレードオフがあれば提案してください。」

#### 実装方針を相談したいとき

「[タスクの要約]を実装したい。このリポジトリのコードベースを踏まえて、最適な実装方針を提案してください。」

### プロンプトの構成

1. プロジェクトの背景（簡潔に）
2. 相談したい具体的な内容
3. codexに期待する回答の観点（レビュー、設計提案、実装方針など）

## 3. codexの実行

Bashツールで以下の形式で実行する:

```
codex exec --ephemeral -s workspace-write -c sandbox_workspace_write.network_access=true "ここにプロンプトを入れる"
```

### 重要なオプション

- `--ephemeral` は必須。セッションを保存しない
- `-s workspace-write -c sandbox_workspace_write.network_access=true` は必須。デフォルトではサンドボックスがネットワークアクセスをブロックするため、`gh`や`curl`などの外部通信コマンドが失敗する
- ワーキングディレクトリはカレントディレクトリがそのまま使われる
- プロンプトはCLI引数として渡す（標準入力ではない）

### タイムアウト

codexの実行には時間がかかる場合がある。Bashツールのtimeoutを600000（10分）に設定する。

## 4. 結果の要約と報告

codexの出力を読み取り、以下の構成でユーザーに報告する:

### 報告の構成

#### codexへの相談内容

codexに送ったプロンプトの概要を1-2文で説明する。

#### codexの回答サマリー

codexの主な指摘・提案を箇条書きで要約する。

#### Claudeの見解

- codexの指摘のうち、Claudeも同意するもの
- codexの指摘のうち、Claudeが異なる意見を持つもの（理由付き）
- codexが見落としているとClaudeが考えるポイント

#### 次のアクション提案

ユーザーと相談すべき事項や、推奨する次のステップを示す。

### 報告のスタイル

- 簡潔にまとめる。冗長な引用は避ける
- codexとClaudeの見解が異なる場合は、両方の理由を説明してユーザーが判断できるようにする
- ユーザーが次に何をすべきか明確にする

### codexの出力が大きすぎる場合

codexの出力量が多く、要約や処理が困難だと判断した場合は、以下の手順に従う:

1. まずユーザーに「codexの出力が非常に長かった」旨を報告する
2. 出力の冒頭部分から読み取れる概要だけを伝える
3. ユーザーと相談して対処方法を決める（例: 観点を絞って再実行、プロンプトに出力量の制約を追加、など）

事前にプロンプトで出力量を制限しない。制限すると重要な情報が欠落するリスクがある。

### codexのコマンド失敗を検知した場合

codexの出力を読む際、コマンド実行の失敗の兆候がないか注意深く確認する。
兆候の例: エラーメッセージ、「取得できなかった」「失敗した」「permission denied」「not found」など。

失敗を検知した場合は、以下の手順に従う:

1. まず、Claudeが正しい情報を自分で取得する。codexが失敗したコマンド（例: `gh pr view`）をBashツールで実行し、結果を確認する
2. 次に、取得した情報でcodexの分析を補正する。情報不足で的外れになった指摘を特定し、正しい文脈で再評価する
3. 最後に、報告の「Claudeの見解」で情報不足を明示する。欠落情報と、その影響を受けた指摘を具体的に説明する
